
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Generador de enlaces de afiliado Amazon</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; background: #0b1020; color: #e6e8f0; }
    .wrap { max-width: 780px; margin: 0 auto; padding: 24px; }
    .card { background: #121a34; border: 1px solid #263055; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 8px; font-size: 24px; }
    p { color: #b8c0dd; }
    label { display:block; margin: 16px 0 8px; font-weight: 600; }
    input[type="text"] { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #33406d; background: #0c1430; color: #e6e8f0; outline: none; }
    input[type="text"]::placeholder { color: #90a0d0; }
    .btns { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; align-items: center; }
    button { padding: 10px 14px; border: 1px solid #3a4a84; background:#1b2550; color:#e6e8f0; border-radius: 12px; cursor:pointer; }
    button:hover { background:#223066; }
    small.muted { color:#93a2cf }
    .ok { color: #8ef0b1; font-weight: 600; }
    .warn { color: #ffd27f; font-weight: 600; }
    .err { color: #ff8e8e; font-weight: 600; }
    .foot { margin-top: 18px; font-size: 13px; color:#93a2cf }
    code.k { background:#0c1430; border:1px solid #33406d; padding:2px 6px; border-radius:8px }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Generador de enlaces de afiliado Amazon</h1>
      <p>Pega una URL de Amazon y usa <strong>Pegar desde portapapeles</strong> o pulsa <strong>Abrir en Amazon</strong>.</p>

      <label for="in">URL de Amazon</label>
      <input id="in" type="text" placeholder="Ej.: https://www.amazon.es/dp/B0C1234567?ref_=..." />

      <div class="btns">
        <button id="paste">Pegar desde portapapeles</button>
        <button id="open">Abrir en Amazon</button>
        <button id="clear">Limpiar</button>
      </div>

      <div id="status" class="foot"></div>

      <div class="foot">
        <strong>Nota:</strong> Los enlaces acortados <code class="k">amzn.to</code> no pueden expandirse aquí (limitación del navegador). Pega la URL completa del producto.
      </div>

      <div class="foot">
        <em>Recordatorio:</em> el <code class="k">tag=</code> se verá en la barra de direcciones de Amazon tras abrir la página (normal y conforme a políticas).
      </div>
    </div>
  </div>

<script>
"use strict";

/* ====== TUS TAGS Y SUBTAG FIJO (no se muestran en la interfaz) ====== */
const DEFAULT_TAG = "keytrading-21";  // ← tu tag principal (.es suele acabar en -21)
const FIXED_SUBTAG = "";              // p.ej. "instagram-ago25" o "" para no usar ascsubtag
const TAGS_BY_DOMAIN = {
  "amazon.es": "keytrading-21",
  "www.amazon.es": "keytrading-21",
  // "amazon.com": "TU_TAG_US",      "www.amazon.com": "TU_TAG_US",
  // "amazon.co.uk": "TU_TAG_UK",    "www.amazon.co.uk": "TU_TAG_UK",
  // "amazon.de": "TU_TAG_DE",       "www.amazon.de": "TU_TAG_DE",
  // "amazon.fr": "TU_TAG_FR",       "www.amazon.fr": "TU_TAG_FR",
  // "amazon.it": "TU_TAG_IT",       "www.amazon.it": "TU_TAG_IT",
  // "amazon.com.mx": "TU_TAG_MX",   "www.amazon.com.mx": "TU_TAG_MX",
  // "amazon.ca": "TU_TAG_CA",       "www.amazon.ca": "TU_TAG_CA",
  // "amazon.com.au": "TU_TAG_AU",   "www.amazon.com.au": "TU_TAG_AU",
  // "amazon.co.jp": "TU_TAG_JP",    "www.amazon.co.jp": "TU_TAG_JP",
  // "amazon.nl": "TU_TAG_NL",       "www.amazon.nl": "TU_TAG_NL",
  // "amazon.se": "TU_TAG_SE",       "www.amazon.se": "TU_TAG_SE",
  // "amazon.pl": "TU_TAG_PL",       "www.amazon.pl": "TU_TAG_PL",
  // "amazon.com.tr": "TU_TAG_TR",   "www.amazon.com.tr": "TU_TAG_TR",
  // "amazon.ae": "TU_TAG_AE",       "www.amazon.ae": "TU_TAG_AE",
  // "amazon.sa": "TU_TAG_SA",       "www.amazon.sa": "TU_TAG_SA",
  // "amazon.sg": "TU_TAG_SG",       "www.amazon.sg": "TU_TAG_SG",
  // "amazon.in": "TU_TAG_IN",       "www.amazon.in": "TU_TAG_IN",
  // "amazon.eg": "TU_TAG_EG",       "www.amazon.eg": "TU_TAG_EG",
  // "amazon.com.be": "TU_TAG_BE",   "www.amazon.com.be": "TU_TAG_BE",
};

/* ====== QUITAMOS TRACKING BASURA, CONSERVAMOS VARIANTES/IDIOMA ====== */
const DROP_EXACT = [
  "ref", "ref_", "qid", "sr", "crid",
  "linkCode", "linkId", "camp", "creative", "creativeASIN",
  "aaxitk", "sp_csd", "tag", "ascsubtag", "content-id"
];
const DROP_PREFIX = ["pf_rd_", "pd_rd_"];

/* ====== MARKETPLACES: detectar país por dominio ====== */
const MARKET_MAP = {
  "amazon.com": "US", "amazon.es": "ES", "amazon.de": "DE", "amazon.fr": "FR",
  "amazon.it": "IT", "amazon.co.uk": "UK", "amazon.ca": "CA", "amazon.com.mx": "MX",
  "amazon.com.br": "BR", "amazon.com.au": "AU", "amazon.co.jp": "JP",
  "amazon.nl": "NL", "amazon.se": "SE", "amazon.pl": "PL", "amazon.com.tr": "TR",
  "amazon.ae": "AE", "amazon.sa": "SA", "amazon.sg": "SG", "amazon.in": "IN",
  "amazon.eg": "EG", "amazon.com.be": "BE"
};

function normalizeAmazonHostname(hostname) {
  let host = hostname.replace(/^m\./i, "").replace(/^smile\./i, "");
  if (!/^www\./i.test(host)) host = "www." + host;
  return host;
}
function domainTagFor(hostname, fallbackTag) {
  const key = hostname.replace(/^www\./i, "");
  return TAGS_BY_DOMAIN[key] || fallbackTag || DEFAULT_TAG;
}
function marketplaceFromHost(hostname) {
  const key = hostname.replace(/^www\./i, "").toLowerCase();
  return MARKET_MAP[key] || key.split(".").pop().toUpperCase();
}

/* ====== NÚCLEO: LIMPIAR + ETIQUETAR ====== */
function cleanAndTag(u, affiliateTag, fixedSubtag) {
  u.hostname = normalizeAmazonHostname(u.hostname);
  u.protocol = "https:";

  for (const key of Array.from(u.searchParams.keys())) {
    if (DROP_EXACT.includes(key)) u.searchParams.delete(key);
    if (DROP_PREFIX.some(p => key.startsWith(p))) u.searchParams.delete(key);
  }

  u.searchParams.set("tag", affiliateTag);
  if (fixedSubtag) u.searchParams.set("ascsubtag", fixedSubtag);

  return u.toString();
}

function convertRaw(raw, fallbackTag, fixedSubtag) {
  if (!raw) throw new Error("Pega una URL de Amazon.");
  let s = raw.trim();
  if (!/^https?:\/\//i.test(s)) s = "https://" + s;

  let u;
  try { u = new URL(s); }
  catch { throw new Error("La URL no es válida."); }

  const host = u.hostname.toLowerCase();
  if (host === "amzn.to") throw new Error("Es un link acortado (amzn.to). Pega la URL completa del producto.");
  if (!/amazon\./i.test(host)) throw new Error("Esto no parece un enlace de Amazon.");

  const affiliateTag = domainTagFor(host, fallbackTag);
  const url = cleanAndTag(u, affiliateTag, fixedSubtag || "");
  return url;
}

/* ====== UI ====== */
document.addEventListener("DOMContentLoaded", () => {
  const $in = document.getElementById("in");
  const $status = document.getElementById("status");

  function appendStatus(html) {
    $status.innerHTML = ($status.innerHTML ? $status.innerHTML + "<br>" : "") + html;
  }
  function clearStatus() { $status.innerHTML = ""; }

  async function pasteFromClipboard() {
    clearStatus();
    try {
      const txt = await navigator.clipboard.readText();
      if (!txt || !txt.trim()) {
        appendStatus('<span class="warn">No hay nada útil en el portapapeles.</span>');
        return;
      }
      $in.value = txt.trim();
      appendStatus('<span class="ok">✓ Enlace pegado desde el portapapeles.</span>');
    } catch (e) {
      console.error(e);
      appendStatus('<span class="warn">No pude leer el portapapeles. Pega manualmente (Cmd/Ctrl + V).</span>');
    }
  }

  function openInAmazon() {
    try {
      const url = convertRaw($in.value, DEFAULT_TAG, FIXED_SUBTAG);
      const u2 = new URL(url);
      const host = u2.hostname.replace(/^www\./i, "");
      const country = marketplaceFromHost(u2.hostname);

      appendStatus('<span class="ok">✓ Nuevo enlace afiliado generado correctamente.</span> ' +
                   `<span class="muted">(Dominio: ${host} · País: ${country})</span>`);
      window.open(url, "_blank", "noopener");
      appendStatus('<span class="ok">✓ Enlace abierto en una nueva pestaña.</span>');
    } catch (e) {
      console.error(e);
      appendStatus('<span class="err">⚠ ' + e.message + '</span>');
    }
  }

  document.getElementById("paste").addEventListener("click", pasteFromClipboard);
  document.getElementById("open").addEventListener("click", openInAmazon);
  document.getElementById("clear").addEventListener("click", () => { $in.value = ""; clearStatus(); });

  // Enter para abrir directamente
  $in.addEventListener("keydown", e => { if (e.key === "Enter") openInAmazon(); });
});
</script>
</body>
</html>




